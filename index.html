<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Stock Dashboard — Meme Z-Score + AI Advice</title>
<style>
:root{--bg:#0b0f14;--card:#121821;--muted:#9bb0c6;--text:#e7f0f7;--accent:#59c2ff;--border:#1f2a36;--green:#35d07f;--red:#ff6b6b}
*{box-sizing:border-box}body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
header{position:sticky;top:0;background:rgba(11,15,20,.9);backdrop-filter:blur(8px);border-bottom:1px solid var(--border);padding:10px 14px}
h1{margin:0;font-weight:600;font-size:18px}
.badge{background:#0f2533;color:#bfeaff;border-radius:999px;padding:4px 8px;margin-left:8px;font-size:12px}
#tabs{display:flex;gap:6px;margin-top:10px;flex-wrap:wrap}
.tab{padding:8px 10px;border:1px solid var(--border);border-radius:10px;background:#0f1620;cursor:pointer;color:#cfe6ff}
.tab.active{background:#163146;color:#fff;border-color:#244861}
main{max-width:1200px;margin:0 auto;padding:16px}
.card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:14px;margin:10px 0}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
label{color:#c8d7e3}
input,select,button,textarea{background:#0f1620;color:#e7f0f7;border:1px solid var(--border);border-radius:8px;padding:6px 10px}
button{cursor:pointer}
table{width:100%;border-collapse:collapse}
th,td{padding:8px;border-bottom:1px solid var(--border);font-size:14px}
th{color:#b9c9d9;text-align:left}
td.right{text-align:right}
small.muted{color:var(--muted)}
.ok{color:var(--green)}.bad{color:var(--red)}
pre{white-space:pre-wrap;word-break:break-word}
#aiMode{margin-left:8px}
footer{color:#9bb0c6;text-align:center;padding:20px 10px}
a{color:#9dd1ff}
</style>
</head>
<body>
<header>
  <h1>Stock Dashboard <span class="badge">Meme Z-Score + AI Advice</span> <span id="statusPills" class="badge">Checking…</span></h1>
  <div id="tabs">
    <div class="tab active" data-tab="core">Core</div>
    <div class="tab" data-tab="penny">Penny</div>
    <div class="tab" data-tab="pl">P&amp;L</div>
    <div class="tab" data-tab="news">News</div>
    <div class="tab" data-tab="memes">Memes</div>
    <div class="tab" data-tab="ai">AI</div>
  </div>
</header>

<main>
  <section class="card row">
    <div class="row">
      <label>Backend:</label>
      <input id="backend" size="36" value="https://opendoorstock.netlify.app"> 
      <button id="saveCfg">Save</button>
      <small class="muted">Auto refresh every 2 min.</small>
    </div>
    <div class="row">
      <label>Core symbols:</label>
      <input id="coreInput" size="40" value="OPEN,LX,LCID,META,2222.SR">
      <label>Penny symbols:</label>
      <input id="pennyInput" size="30" value="">
      <button id="applySymbols">Apply</button>
    </div>
  </section>

  <section id="view-core" class="card">
    <h3>Core Watchlist</h3>
    <table id="tbl-core"><thead><tr>
      <th>Ticker</th><th class="right">Price</th><th class="right">% Chg</th><th>Notes</th>
    </tr></thead><tbody></tbody></table>
  </section>

  <section id="view-penny" class="card" style="display:none">
    <h3>Penny Watchlist</h3>
    <table id="tbl-penny"><thead><tr>
      <th>Ticker</th><th class="right">Price</th><th class="right">% Chg</th><th>Notes</th>
    </tr></thead><tbody></tbody></table>
    <small class="muted">Add symbols above and press Apply.</small>
  </section>

  <section id="view-pl" class="card" style="display:none">
    <h3>P&amp;L Snapshot</h3>
    <table id="tbl-pl"><thead><tr>
      <th>Ticker</th><th class="right">Shares</th><th class="right">Avg Cost</th><th class="right">Last</th><th class="right">P/L</th><th class="right">P/L %</th>
    </tr></thead><tbody></tbody></table>
    <small class="muted">Preloaded with your OPEN position. You can edit JSON below and press Save.</small>
    <div class="row" style="margin-top:8px">
      <textarea id="plJson" rows="6" style="width:100%"></textarea>
    </div>
    <div class="row"><button id="savePL">Save P&amp;L</button></div>
  </section>

  <section id="view-news" class="card" style="display:none">
    <h3>News Feed</h3>
    <div id="newsList"></div>
  </section>

  <section id="view-memes" class="card" style="display:none">
    <h3>Memes Radar</h3>
    <div id="memesSummary" class="row"></div>
    <div id="memesDetails"></div>
  </section>

  <section id="view-ai" class="card" style="display:none">
    <h3>AI Recommendations 
      <select id="aiMode">
        <option value="scalper">Scalper (min‑hrs)</option>
        <option value="swing" selected>Swing (days‑weeks)</option>
        <option value="longterm">Long‑Term</option>
      </select>
    </h3>
    <table id="tbl-ai"><thead><tr>
      <th>Ticker</th><th class="right">Price</th><th class="right">% Chg</th><th>Advice</th>
    </tr></thead><tbody></tbody></table>
    <small class="muted">AI uses OpenAI if OPENAI_KEY is set; otherwise rules fallback. Meme Z-score computed locally.</small>
  </section>
</main>

<footer>
  <small>Signals are informational only, not financial advice. Last updated: <span id="stamp"></span></small>
</footer>

<script>
const LSget = (k,def=null)=>{ try{ const v = localStorage.getItem(k); return v? JSON.parse(v): def; }catch{ return def; } };
const LSset = (k,v)=> localStorage.setItem(k, JSON.stringify(v));

const backendEl = document.getElementById("backend");
const coreInput  = document.getElementById("coreInput");
const pennyInput = document.getElementById("pennyInput");
const aiModeEl   = document.getElementById("aiMode");
const statusPill = document.getElementById("statusPills");

backendEl.value = LSget("backend", "https://opendoorstock.netlify.app");
coreInput.value = LSget("core", "OPEN,LX,LCID,META,2222.SR");
pennyInput.value = LSget("penny", "");
aiModeEl.value  = LSget("aimode", "swing");

document.getElementById("saveCfg").onclick = ()=> { LSset("backend", backendEl.value); alert("Saved."); };
document.getElementById("applySymbols").onclick = ()=> { LSset("core", coreInput.value); LSset("penny", pennyInput.value); init(true); };
aiModeEl.onchange = ()=> { LSset("aimode", aiModeEl.value); runAI(); };

document.querySelectorAll(".tab").forEach(t=> t.addEventListener("click", ev => {
  document.querySelectorAll(".tab").forEach(x=>x.classList.remove("active"));
  ev.currentTarget.classList.add("active");
  const tab = ev.currentTarget.getAttribute("data-tab");
  document.querySelectorAll("main > section.card").forEach(sec => sec.style.display = "none");
  document.getElementById("view-"+tab).style.display = "";
}));

const S = { quotes:{}, news:[], memes:{}, pl:{} };

if(!LSget("pl")){
  LSset("pl", {
    "OPEN": { shares: 15010.2311, avgCost: 2.24 },
    "LX":   { shares: 0, avgCost: 0 },
    "LCID": { shares: 0, avgCost: 0 },
    "META": { shares: 0, avgCost: 0 },
    "2222.SR": { shares: 0, avgCost: 0 }
  });
}
document.getElementById("plJson").value = JSON.stringify(LSget("pl"), null, 2);
document.getElementById("savePL").onclick = ()=> { 
  try{ const j = JSON.parse(document.getElementById("plJson").value); LSset("pl", j); renderPL(); alert("P&L saved."); }
  catch(e){ alert("Invalid JSON"); }
};

function stamp(){ const d=new Date(); document.getElementById("stamp").textContent = d.toLocaleString(); }
function listSymbols(kind="core"){ const txt=(kind==="core"?coreInput.value:pennyInput.value)||""; return txt.split(",").map(s=>s.trim()).filter(Boolean); }
async function jget(url){ const r=await fetch(url,{cache:"no-store"}); if(!r.ok) throw new Error("HTTP "+r.status+" "+url); return r.json(); }
function priceCell(v){ return v==null? "—" : Number(v).toFixed(2); }
function pctCell(v){ if(v==null) return "—"; const s=Number(v).toFixed(2)+"%"; return Number(v)>=0? `<span class="ok">${s}</span>`:`<span class="bad">${s}</span>`; }
function ensureRow(tbody, id, cols){ let tr=tbody.querySelector(`tr[data-id="${id}"]`); if(!tr){ tr=document.createElement("tr"); tr.dataset.id=id; tr.innerHTML=cols; tbody.appendChild(tr);} return tr; }

function recordMemeHistory(memesObj){
  const hist = LSget("meme_hist", {});
  const ts = Date.now();
  for(const [sym, val] of Object.entries(memesObj||{})){
    const score = Number(val?.score || 0);
    if(!hist[sym]) hist[sym] = [];
    hist[sym].push({ ts, score });
    if(hist[sym].length > 200) hist[sym] = hist[sym].slice(-200);
  }
  LSset("meme_hist", hist);
}
function memeZ(sym, currentScore){
  const hist = (LSget("meme_hist", {})[sym] || []).slice(-40).map(x=>x.score);
  if(hist.length < 6) return 0;
  const avg = hist.reduce((a,b)=>a+b,0)/hist.length;
  const sd  = Math.sqrt(hist.map(x=>(x-avg)**2).reduce((a,b)=>a+b,0)/hist.length) || 1;
  return (Number(currentScore||0)-avg)/sd;
}
function deriveTags(sym, q, levels, memeScore, z){
  const tags = []; const price=Number(q?.price||0); const ch=Number(q?.changePct||0);
  const s1=Number((levels?.support||[])[0]||0); const r1=Number((levels?.resistance||[])[0]||0);
  if (ch > 3 && z > 1) tags.push("momentum_breakout");
  if (ch < -3 && z > 1) tags.push("meme_vs_price_divergence");
  if (price && r1 && price >= r1*0.995) tags.push("near_resistance");
  if (price && s1 && price <= s1*1.01) tags.push("near_support");
  return tags;
}

async function loadQuotes(symbols){
  const base = backendEl.value.trim().replace(/\/$/,"");
  const j = await jget(`${base}/.netlify/functions/quotes?symbols=${encodeURIComponent(symbols.join(","))}`);
  S.quotes = Object.assign(S.quotes, j.quotes||{});
}
async function loadNews(symbols){
  const base = backendEl.value.trim().replace(/\/$/,"");
  const j = await jget(`${base}/.netlify/functions/news?symbols=${encodeURIComponent(symbols.join(","))}`);
  S.news = j.news || [];
}
async function loadMemes(symbols){
  const base = backendEl.value.trim().replace(/\/$/,"");
  const j = await jget(`${base}/.netlify/functions/memes?symbols=${encodeURIComponent(symbols.join(","))}`);
  S.memes = j.memes || {};
  recordMemeHistory(S.memes);
}

function renderCore(symbols){
  const tbody = document.querySelector("#tbl-core tbody"); tbody.innerHTML="";
  symbols.forEach(sym=>{
    const q = S.quotes[sym]||{};
    ensureRow(tbody, sym, `<td>${sym}</td><td class="right" id="cpx-${sym}">—</td><td class="right" id="cch-${sym}">—</td><td>${sym==="OPEN" ? "$3.50/$2.30/$1.80" : ""}</td>`);
    document.getElementById(`cpx-${sym}`).innerHTML = priceCell(q.price);
    document.getElementById(`cch-${sym}`).innerHTML = pctCell(q.changePct);
  });
}
function renderPenny(symbols){
  const tbody = document.querySelector("#tbl-penny tbody"); tbody.innerHTML="";
  symbols.forEach(sym=>{
    const q = S.quotes[sym]||{};
    ensureRow(tbody, sym, `<td>${sym}</td><td class="right" id="ppx-${sym}">—</td><td class="right" id="pch-${sym}">—</td><td></td>`);
    document.getElementById(`ppx-${sym}`).innerHTML = priceCell(q.price);
    document.getElementById(`pch-${sym}`).innerHTML = pctCell(q.changePct);
  });
}
function renderPL(){
  const pl = LSget("pl") || {}; const tbody = document.querySelector("#tbl-pl tbody"); tbody.innerHTML="";
  Object.keys(pl).forEach(sym=>{
    const pos = pl[sym]; const q = S.quotes[sym]||{}; const last = Number(q.price||0);
    const plVal = last>0 ? (last - Number(pos.avgCost||0)) * Number(pos.shares||0) : 0;
    const costTot = Number(pos.avgCost||0) * Number(pos.shares||0);
    const plPct = costTot>0 ? (plVal / costTot * 100) : 0;
    ensureRow(tbody, sym, `<td>${sym}</td><td class="right">${(pos.shares||0).toFixed(4)}</td><td class="right">${(pos.avgCost||0).toFixed(2)}</td><td class="right">${last? last.toFixed(2):"—"}</td><td class="right ${plVal>=0?"ok":"bad"}">${plVal.toFixed(2)}</td><td class="right ${plPct>=0?"ok":"bad"}">${plPct.toFixed(2)}%</td>`);
  });
  document.getElementById("plJson").value = JSON.stringify(pl, null, 2);
}
function renderNews(symbols){
  const div = document.getElementById("newsList"); div.innerHTML="";
  const items = (S.news||[]).filter(n => symbols.some(s => (n.title||"").toUpperCase().includes(s.toUpperCase())));
  if(items.length===0){ div.innerHTML = `<small class="muted">No news yet. Ensure NEWSAPI_KEY is set on Netlify.</small>`; return; }
  items.slice(0,40).forEach(n=>{
    const el = document.createElement("div");
    el.className="card";
    el.innerHTML = `<b><a href="${n.url}" target="_blank" rel="noopener">${n.title||"Untitled"}</a></b><br>
                    <small class="muted">${n.source||""} · ${(new Date(n.published_at||n.publishedAt||Date.now())).toLocaleString()}</small>
                    <div>${n.summary||n.description||""}</div>`;
    div.appendChild(el);
  });
}
function renderMemes(symbols){
  const sum = document.getElementById("memesSummary"); sum.innerHTML="";
  const det = document.getElementById("memesDetails"); det.innerHTML="";
  symbols.forEach(sym=>{
    const m = S.memes[sym] || { count:0, score:0, items:[] };
    const z = memeZ(sym, m.score);
    const chip = document.createElement("div");
    chip.className="badge";
    chip.textContent = `${sym}: ${m.count} posts · score ${Number(m.score||0).toFixed(1)} · z ${z.toFixed(2)}`;
    sum.appendChild(chip);

    const box = document.createElement("div"); box.className="card";
    let inner = `<h4>${sym}</h4>`;
    const items = (m.items||[]).slice(0,20);
    if(items.length===0){ inner += `<small class="muted">No items yet.</small>`; }
    else {
      inner += `<ul>` + items.map(it => `<li><a href="${it.url}" target="_blank">${(it.title||"").slice(0,140)}</a> <small class="muted">(${it.platform||it.sub||"reddit"}, ↑${it.ups||0})</small></li>`).join("") + `</ul>`;
    }
    box.innerHTML = inner;
    det.appendChild(box);
  });
}

async function runAI(){
  const mode = aiModeEl.value;
  const base = backendEl.value.trim().replace(/\/$/,"");
  const symbols = listSymbols("core");
  const tbody = document.querySelector("#tbl-ai tbody"); tbody.innerHTML="";
  for(const sym of symbols){
    const q = S.quotes[sym]||{};
    const m = S.memes[sym] || { score:0, items:[] };
    const levels = sym==="OPEN" ? { support:["2.30","2.40"], resistance:["3.50"], stop:["1.80"] } : {};
    const z = memeZ(sym, m.score);
    const tags = deriveTags(sym, q, levels, m.score, z);
    const data = {
      quote: { price: q.price, changePct: q.changePct },
      levels,
      news: (S.news||[]).filter(n => (n.title||"").toUpperCase().includes(sym)).slice(0,5),
      memes: m,
      memeFeatures: { memeScore: m.score, memeZ: Number(z.toFixed(2)), tags }
    };
    const row = ensureRow(tbody, sym, `<td>${sym}</td><td class="right" id="aip-${sym}">—</td><td class="right" id="aic-${sym}">—</td><td id="aid-${sym}">Thinking…</td>`);
    document.getElementById(`aip-${sym}`).innerHTML = priceCell(q.price);
    document.getElementById(`aic-${sym}`).innerHTML = pctCell(q.changePct);
    try{
      const r = await fetch(`${base}/.netlify/functions/ai`, {
        method:"POST", headers: {"content-type":"application/json"},
        body: JSON.stringify({ symbol: sym, data, mode })
      });
      const j = await r.json();
      document.getElementById(`aid-${sym}`).textContent = j.advice || "No advice";
    }catch(e){
      document.getElementById(`aid-${sym}`).textContent = "AI fallback active (endpoint error)";
    }
  }
}

async function refreshAll(){
  const coreSyms = listSymbols("core");
  const pennySyms = listSymbols("penny");
  const union = [...new Set([...coreSyms, ...pennySyms])];
  try{
    await Promise.all([loadQuotes(union), loadNews(union), loadMemes(union)]);
    renderCore(coreSyms); renderPenny(pennySyms); renderPL(); renderNews(union); renderMemes(union);
    await runAI();
    statusPill.textContent = "OK";
    statusPill.style.background = "#123d2a";
  }catch(e){
    console.error(e);
    statusPill.textContent = "Backend ERR";
    statusPill.style.background = "#4a1f1f";
  }
  const d = new Date(); document.getElementById("stamp").textContent = d.toLocaleString();
}
function listSymbols(kind="core"){
  const txt=(kind==="core"?coreInput.value:pennyInput.value)||""; return txt.split(",").map(s=>s.trim()).filter(Boolean);
}
async function init(force){
  if(force){ S.quotes={}; S.news=[]; S.memes={}; }
  await refreshAll();
  if(window._timer) clearInterval(window._timer);
  window._timer = setInterval(refreshAll, 120000);
}
init();
</script>
</body>
</html>
