
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<title>OPEN Dashboard — DEBUG</title>
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;margin:16px;background:#0b0f14;color:#e7f0f7}
  .row{display:flex;flex-wrap:wrap;gap:12px;margin-bottom:12px}
  .card{flex:1 1 340px;background:#121821;border:1px solid #1f2a36;border-radius:12px;padding:12px;min-width:320px}
  .muted{color:#9bb0c6;font-size:12px}
  pre{white-space:pre-wrap;word-break:break-word;background:#0e141c;border:1px solid #1f2a36;border-radius:8px;padding:8px;color:#e7f0f7;max-height:320px;overflow:auto}
  code{color:#bfeaff}
  .ok{color:#4cd964} .bad{color:#ff6b6b}
  table{width:100%;border-collapse:collapse} th,td{padding:6px;border-bottom:1px solid #1f2a36} th{color:#b9c9d9;text-align:left}
  input{width:100%;padding:6px;border-radius:8px;border:1px solid #1f2a36;background:#0e141c;color:#e7f0f7}
</style>
</head>
<body>
<h1>OPEN Dashboard — DEBUG</h1>
<p class="muted">Backend base: <code id="bb"></code></p>

<div class="row">
  <div class="card">
    <h3>Connectivity checks</h3>
    <ul id="checks" class="muted"></ul>
  </div>
  <div class="card">
    <h3>Live Watchlist</h3>
    <table id="tbl"><thead><tr><th>Ticker</th><th>Price</th><th>Chg%</th></tr></thead><tbody></tbody></table>
  </div>
</div>

<div class="row">
  <div class="card"><h3>hello() response</h3><pre id="helloBox">pending…</pre></div>
  <div class="card"><h3>quotes() response</h3><pre id="quotesBox">pending…</pre></div>
</div>
<div class="row">
  <div class="card"><h3>news() response</h3><pre id="newsBox">pending…</pre></div>
  <div class="card"><h3>sentiment() response</h3><pre id="sentBox">pending…</pre></div>
</div>

<script>
const BACKEND_BASE = "https://opendoorstock.netlify.app";
document.getElementById('bb').textContent = BACKEND_BASE;

const CORE = ["OPEN","LX","LCID","META","2222.SR","BEST"];

function addCheck(msg, ok, extra=""){ 
  const li=document.createElement("li"); 
  li.innerHTML = (ok? "<span class='ok'>✓</span> ": "<span class='bad'>✗</span> ")+ msg + (extra? " — <span class='muted'>"+extra+"</span>":"");
  document.getElementById("checks").appendChild(li);
}

async function getJSON(url, boxId){
  const box = document.getElementById(boxId);
  try{ 
    const r = await fetch(url, {cache:"no-store"});
    const txt = await r.text();
    let parsed=null;
    try{ parsed = JSON.parse(txt); }catch(e){}
    box.textContent = parsed? JSON.stringify(parsed,null,2): ("HTTP "+r.status+"\n"+txt);
    return parsed || txt;
  }catch(e){
    box.textContent = "FETCH ERROR: "+e.message;
    return null;
  }
}

function renderQuotes(map){
  const tb = document.querySelector("#tbl tbody"); tb.innerHTML="";
  CORE.forEach(sym=>{
    const q = map?.quotes?.[sym];
    const price = (q && q.price!=null) ? q.price : "—";
    const ch = (q && q.changePct!=null) ? q.changePct : "—";
    const tr=document.createElement("tr"); tr.innerHTML=`<td>${sym}</td><td>${price}</td><td>${ch}</td>`;
    tb.appendChild(tr);
  });
}

(async function(){
  // 0) Simple CORS test to the domain
  try{ const r = await fetch(BACKEND_BASE+"/index.html", {cache:"no-store"}); addCheck("Reach backend /index.html", r.ok, "HTTP "+r.status); }
  catch(e){ addCheck("Reach backend /index.html", false, e.message); }

  // 1) hello
  const hello = await getJSON(BACKEND_BASE+"/.netlify/functions/hello", "helloBox");
  addCheck("hello() JSON", !!hello && (hello.ok===true || typeof hello==="object"));

  // 2) quotes
  const quotes = await getJSON(BACKEND_BASE+"/.netlify/functions/quotes?symbols="+encodeURIComponent(CORE.join(",")), "quotesBox");
  const okQuotes = !!(quotes && quotes.quotes && quotes.quotes.OPEN);
  addCheck("quotes() shape {quotes:{OPEN:{price}}}", okQuotes);
  if (okQuotes) renderQuotes(quotes);

  // 3) news
  const news = await getJSON(BACKEND_BASE+"/.netlify/functions/news?symbols=OPEN,LCID", "newsBox");
  addCheck("news() shape {news:[...]}", !!(news && Array.isArray(news.news)));

  // 4) sentiment
  const sent = await getJSON(BACKEND_BASE+"/.netlify/functions/sentiment?symbols=OPEN,LCID", "sentBox");
  addCheck("sentiment() shape {sentiment:{OPEN:...}}", !!(sent && sent.sentiment && sent.sentiment.OPEN));
})();
</script>
</body>
</html>
